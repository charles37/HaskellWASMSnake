var e;class t{static read_bytes(e,r){let n=new t;return n.buf=e.getUint32(r,!0),n.buf_len=e.getUint32(r+4,!0),n}static read_bytes_array(e,r,n){let s=[];for(let i=0;i<n;i++)s.push(t.read_bytes(e,r+8*i));return s}}class r{static read_bytes(e,t){let n=new r;return n.buf=e.getUint32(t,!0),n.buf_len=e.getUint32(t+4,!0),n}static read_bytes_array(e,t,n){let s=[];for(let i=0;i<n;i++)s.push(r.read_bytes(e,t+8*i));return s}}class n{d_ino=1n;constructor(e,t,r){let n=new TextEncoder("utf-8").encode(t);this.d_next=e,this.d_namlen=n.byteLength,this.d_type=r,this.dir_name=n}length(){return 24+this.dir_name.byteLength}write_bytes(e,t,r){e.setBigUint64(r,this.d_next,!0),e.setBigUint64(r+8,this.d_ino,!0),e.setUint32(r+16,this.dir_name.length,!0),e.setUint8(r+20,this.d_type),t.set(this.dir_name,r+24)}}class s{fs_rights_base=0n;fs_rights_inherited=0n;constructor(e,t){this.fs_filetype=e,this.fs_flags=t}write_bytes(e,t){e.setUint8(t,this.fs_filetype),e.setUint16(t+2,this.fs_flags,!0),e.setBigUint64(t+8,this.fs_rights_base,!0),e.setBigUint64(t+16,this.fs_rights_inherited,!0)}}class i{dev=0n;ino=0n;nlink=0n;atim=0n;mtim=0n;ctim=0n;constructor(e,t){this.filetype=e,this.size=BigInt(t)}write_bytes(e,t){e.setBigUint64(t,this.dev,!0),e.setBigUint64(t+8,this.ino,!0),e.setUint8(t+16,this.filetype),e.setBigUint64(t+24,this.nlink,!0),e.setBigUint64(t+32,this.size,!0),e.setBigUint64(t+38,this.atim,!0),e.setBigUint64(t+46,this.mtim,!0),e.setBigUint64(t+52,this.ctim,!0)}}class f{constructor(e){this.pr_name_len=e}write_bytes(e,t){e.setUint32(t,this.pr_name_len,!0)}}class l{static dir(e){let t=new l;return t.tag=0,t.inner=new f(e),t}write_bytes(e,t){e.setUint32(t,this.tag,!0),this.inner.write_bytes(e,t+4)}}class o{fd_advise(e,t,r){return-1}fd_allocate(e,t){return-1}fd_close(){return-1}fd_datasync(){return-1}fd_fdstat_get(){return{ret:-1,fdstat:null}}fd_fdstat_set_flags(e){return-1}fd_fdstat_set_rights(e,t){return-1}fd_filestat_get(){return{ret:-1,filestat:null}}fd_filestat_set_size(e){return-1}fd_filestat_set_times(e,t,r){return-1}fd_pread(e,t,r){return{ret:-1,nread:0}}fd_prestat_get(){return{ret:-1,prestat:null}}fd_prestat_dir_name(e,t){return{ret:-1,prestat_dir_name:null}}fd_pwrite(e,t,r){return{ret:-1,nwritten:0}}fd_read(e,t){return{ret:-1,nread:0}}fd_readdir_single(e){return{ret:-1,dirent:null}}fd_seek(e,t){return{ret:-1,offset:0}}fd_sync(){return-1}fd_tell(){return{ret:-1,offset:0}}fd_write(e,t){return{ret:-1,nwritten:0}}path_create_directory(e){return-1}path_filestat_get(e,t){return{ret:-1,filestat:null}}path_filestat_set_times(e,t,r,n,s){return-1}path_link(e,t,r,n){return-1}path_open(e,t,r,n,s,i){return{ret:-1,fd_obj:null}}path_readlink(e){return{ret:-1,data:null}}path_remove_directory(e){return-1}path_rename(e,t,r){return-1}path_symlink(e,t){return-1}path_unlink_file(e){return-1}}class a{constructor(e){console.log(e),this.data=new Uint8Array(e)}get size(){return this.data.byteLength}stat(){return new i(4,this.size)}truncate(){this.data=new Uint8Array([])}}class d{constructor(e){this.contents=e}stat(){return new i(3,0)}get_entry_for_path(e){let t=this;for(let r of e.split("/")){if(""==r)break;if(null==t.contents[r])return console.log(r),null;t=t.contents[r]}return t}create_entry_for_path(e){let t=this,r=e.split("/").filter((e=>"/"!=e));for(let e=0;e<r.length;e++){let n=r[e];null!=t.contents[n]||(console.log("create",n),e==r.length-1?t.contents[n]=new a(new ArrayBuffer(0)):t.contents[n]=new d({})),t=t.contents[n]}return t}}class u extends o{file_pos=0n;constructor(e){super(),this.file=e}fd_fdstat_get(){return{ret:0,fdstat:new s(4,0)}}fd_read(e,t){let r=0;for(let n of t){if(!(this.file_pos<this.file.data.byteLength))break;{let t=this.file.data.slice(Number(this.file_pos),Number(this.file_pos+BigInt(n.buf_len)));e.set(t,n.buf),this.file_pos+=BigInt(t.length),r+=t.length}}return{ret:0,nread:r}}fd_seek(e,t){let r;switch(t){case 0:r=e;break;case 1:r=this.file_pos+e;break;case 2:r=this.file.data.byteLength+e;break;default:return{ret:28,offset:0}}return r<0?{ret:28,offset:0}:(this.file_pos=r,{ret:0,offset:r})}fd_write(e,t){let r=0;for(let n of t){let t=e.slice(n.buf,n.buf+n.buf_len);if(this.file_pos+BigInt(t.byteLength)>this.file.size){let e=this.file.data;this.file.data=new Uint8Array(Number(this.file_pos+BigInt(t.byteLength))),this.file.data.set(e)}this.file.data.set(t.slice(0,this.file.size-Number(this.file_pos)),Number(this.file_pos)),this.file_pos+=BigInt(t.byteLength),r+=n.buf_len}return{ret:0,nwritten:r}}fd_filestat_get(){return{ret:0,stat:this.file.stat()}}}class _ extends o{constructor(e){super(),this.dir=e}fd_fdstat_get(){return{ret:0,fdstat:new s(3,0)}}fd_readdir_single(e){if(console.log(e,Object.keys(this.dir.contents).slice(Number(e))),e>=BigInt(Object.keys(this.dir.contents).length))return{ret:0,dirent:null};let t=Object.keys(this.dir.contents)[Number(e)],r=this.dir.contents[t];new TextEncoder("utf-8").encode(t);return{ret:0,dirent:new n(e+1n,t,r.stat().filetype)}}path_filestat_get(e,t){let r=this.dir.get_entry_for_path(t);return null==r?{ret:-1,filestat:null}:{ret:0,filestat:r.stat()}}path_open(e,t,r,n,s,i){let f=this.dir.get_entry_for_path(t);if(null==f){if(1!=(1&r))return{ret:-1,fd_obj:null};f=this.dir.create_entry_for_path(t)}else if(4==(4&r))return{ret:-1,fd_obj:null};if(2==(2&r)&&3!=f.stat().filetype)return{ret:-1,fd_obj:null};if(8==(8&r)&&f.truncate(),f instanceof a)return{ret:0,fd_obj:new u(f)};if(f instanceof d)return{ret:0,fd_obj:new _(f)};throw"dir entry neither file nor dir"}}function c(e,t){return new Uint8Array(V.memory.buffer,e,t)}function h(e,t){const r=t(e.map((e=>{const t=(new TextEncoder).encode(e),r=t.length+1,n=V.callocBuffer(r);return new c(n,r).set(t),n})));return e.forEach(V.freeBuffer),r}function w(e,t){return h([e],(e=>t(e[0])))}function p(e){const t=new TextDecoder("utf8").decode(function(e){let t=new Uint8Array(V.memory.buffer,e);return c(e,t.findIndex((e=>0==e),t))}(e));return V.freeBuffer(e),t}function g(){return V.size()}function m(e,t){h([e,t],(e=>V.save(e[0],e[1])))}function y(e){return p(w(e,(e=>V.load(e))))}e={WASI:class{args=[];env=[];fds=[];inst;wasiImport;start(e){this.inst=e,e.exports._start()}constructor(e,n,s){this.args=e,this.env=n,this.fds=s;let i=this;this.wasiImport={args_sizes_get(e,t){let r=new DataView(i.inst.exports.memory.buffer);r.setUint32(e,i.args.length,!0);let n=0;for(let e of i.args)n+=e.length+1;return r.setUint32(t,n,!0),console.log(r.getUint32(e,!0),r.getUint32(t,!0)),0},args_get(e,t){let r=new DataView(i.inst.exports.memory.buffer),n=new Uint8Array(i.inst.exports.memory.buffer),s=t;for(let s=0;s<i.args.length;s++){r.setUint32(e,t,!0),e+=4;let f=new TextEncoder("utf-8").encode(i.args[s]);n.set(f,t),r.setUint8(t+f.length,0),t+=f.length+1}return console.log(new TextDecoder("utf-8").decode(n.slice(s,t))),0},environ_sizes_get(e,t){let r=new DataView(i.inst.exports.memory.buffer);r.setUint32(e,i.env.length,!0);let n=0;for(let e of i.env)n+=e.length+1;return r.setUint32(t,n,!0),console.log(r.getUint32(e,!0),r.getUint32(t,!0)),0},environ_get(e,t){let r=new DataView(i.inst.exports.memory.buffer),s=new Uint8Array(i.inst.exports.memory.buffer),f=t;for(let i=0;i<n.length;i++){r.setUint32(e,t,!0),e+=4;let f=new TextEncoder("utf-8").encode(n[i]);s.set(f,t),r.setUint8(t+f.length,0),t+=f.length+1}return console.log(new TextDecoder("utf-8").decode(s.slice(f,t))),0},clock_res_get(e,t){throw"unimplemented"},clock_time_get(e,t,r){let n=new DataView(i.inst.exports.memory.buffer);return 0===e?n.setBigUint64(r,1000000n*BigInt((new Date).getTime()),!0):n.setBigUint64(r,0n,!0),0},fd_advise:(e,t,r,n)=>null!=i.fds[e]?i.fds[e].fd_advise(t,r,n):8,fd_allocate:(e,t,r)=>null!=i.fds[e]?i.fds[e].fd_allocate(t,r):8,fd_close(e){if(null!=i.fds[e]){let t=i.fds[e].fd_close();return i.fds[e]=void 0,t}return 8},fd_datasync:e=>null!=i.fds[e]?i.fds[e].fd_datasync():8,fd_fdstat_get(e,t){if(null!=i.fds[e]){let{ret:r,fdstat:n}=i.fds[e].fd_fdstat_get();return null!=n&&n.write_bytes(new DataView(i.inst.exports.memory.buffer),t),r}return 8},fd_fdstat_set_flags:(e,t)=>null!=i.fds[e]?i.fds[e].fd_fdstat_set_flags(t):8,fd_fdstat_set_rights:(e,t,r)=>null!=i.fds[e]?i.fds[e].fd_fdstat_set_rights(t,r):8,fd_filestat_get(e,t){if(null!=i.fds[e]){let{ret:r,filestat:n}=i.fds[e].fd_filestat_get();return null!=n&&n.write_bytes(new DataView(i.inst.exports.memory.buffer),t),r}return 8},fd_filestat_set_size:(e,t)=>null!=i.fds[e]?i.fds[e].fd_filestat_set_size(t):8,fd_filestat_set_times:(e,t,r,n)=>null!=i.fds[e]?i.fds[e].fd_filestat_set_times(t,r,n):8,fd_pread(e,r,n,s,f){let l=new DataView(i.inst.exports.memory.buffer),o=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let a=t.read_bytes_array(l,r,n),{ret:d,nread:u}=i.fds[e].fd_pread(o,a,s);return l.setUint32(f,u,!0),d}return 8},fd_prestat_get(e,t){let r=new DataView(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let{ret:n,prestat:s}=i.fds[e].fd_prestat_get();return null!=s&&s.write_bytes(r,t),n}return 8},fd_prestat_dir_name(e,t,r){if(null!=i.fds[e]){let{ret:r,prestat_dir_name:n}=i.fds[e].fd_prestat_dir_name();if(null!=n){new Uint8Array(i.inst.exports.memory.buffer).set(n,t)}return r}return 8},fd_pwrite(e,t,n,s,f){let l=new DataView(i.inst.exports.memory.buffer),o=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let a=r.read_bytes_array(l,t,n),{ret:d,nwritten:u}=i.fds[e].fd_pwrite(o,a,s);return l.setUint32(f,u,!0),d}return 8},fd_read(e,r,n,s){let f=new DataView(i.inst.exports.memory.buffer),l=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let o=t.read_bytes_array(f,r,n),{ret:a,nread:d}=i.fds[e].fd_read(l,o);return f.setUint32(s,d,!0),a}return 8},fd_readdir(e,t,r,n,s){let f=new DataView(i.inst.exports.memory.buffer),l=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let o=0;for(;;){let{ret:a,dirent:d}=i.fds[e].fd_readdir_single(n);if(0!=a)return f.setUint32(s,o,!0),a;if(null==d)break;let u=d.length();if(r-o<u)break;d.write_bytes(f,l,t),t+=u,o+=u,n=d.d_next}return f.setUint32(s,o,!0),0}return 8},fd_renumber(e,t){if(null!=i.fds[e]&&null!=i.fds[t]){let r=i.fds[t].fd_close();return 0!=r?r:(i.fds[t]=i.fds[e],i.fds[e]=void 0,0)}return 8},fd_seek(e,t,r,n){let s=new DataView(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let{ret:f,offset_out:l}=i.fds[e].fd_seek(t,r);return s.setUint32(n,l,!0),f}return 8},fd_sync:e=>null!=i.fds[e]?i.fds[e].fd_sync():8,fd_tell(e,t){let r=new DataView(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let{ret:n,offset:s}=i.fds[e].fd_tell();return r.setUint32(t,s,!0),n}return 8},fd_write(e,t,n,s){let f=new DataView(i.inst.exports.memory.buffer),l=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let o=r.read_bytes_array(f,t,n),{ret:a,nwritten:d}=i.fds[e].fd_write(l,o);return f.setUint32(s,d,!0),a}return 8},path_create_directory(e,t,r){let n=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let s=new TextDecoder("utf-8").decode(n.slice(t,t+r));return i.fds[e].path_create_directory(s)}},path_filestat_get(e,t,r,n,s){let f=new DataView(i.inst.exports.memory.buffer),l=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let o=new TextDecoder("utf-8").decode(l.slice(r,r+n)),{ret:a,filestat:d}=i.fds[e].path_filestat_get(t,o);return null!=d&&d.write_bytes(f,s),a}return 8},path_filestat_set_times(e,t,r,n,s,f,l){let o=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let a=new TextDecoder("utf-8").decode(o.slice(r,r+n));return i.fds[e].path_filestat_set_times(t,a,s,f,l)}return 8},path_link(e,t,r,n,s,f,l){let o=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]&&null!=i.fds[s]){let a=new TextDecoder("utf-8").decode(o.slice(r,r+n)),d=new TextDecoder("utf-8").decode(o.slice(f,f+l));return i.fds[s].path_link(e,t,a,d)}return 8},path_open(e,t,r,n,s,f,l,o,a){let d=new DataView(i.inst.exports.memory.buffer),u=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let _=new TextDecoder("utf-8").decode(u.slice(r,r+n));console.log(_);let{ret:c,fd_obj:h}=i.fds[e].path_open(t,_,s,f,l,o);if(0!=c)return c;i.fds.push(h);let w=i.fds.length-1;return d.setUint32(a,w,!0),0}return 8},path_readlink(e,t,r,n,s,f){let l=new DataView(i.inst.exports.memory.buffer),o=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let a=new TextDecoder("utf-8").decode(o.slice(t,t+r));console.log(a);let{ret:d,data:u}=i.fds[e].path_readlink(a);if(null!=u){if(u.length>s)return l.setUint32(f,0,!0),8;o.set(u,n),l.setUint32(f,u.length,!0)}return d}return 8},path_remove_directory(e,t,r){let n=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let s=new TextDecoder("utf-8").decode(n.slice(t,t+r));return i.fds[e].path_remove_directory(s)}return 8},path_rename(e,t,r,n,s,i){throw"FIXME what is the best abstraction for this?"},path_symlink(e,t,r,n,s){let f=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[r]){let l=new TextDecoder("utf-8").decode(f.slice(e,e+t)),o=new TextDecoder("utf-8").decode(f.slice(n,n+s));return i.fds[r].path_symlink(l,o)}return 8},path_unlink_file(e,t,r){let n=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let s=new TextDecoder("utf-8").decode(n.slice(t,t+r));return i.fds[e].path_unlink_file(s)}return 8},poll_oneoff(e,t,r){throw"async io not supported"},proc_exit(e){throw"exit with exit code "+e},proc_raise(e){throw"raised signal "+e},sched_yield(){},random_get(e,t){let r=new Uint8Array(i.inst.exports.memory.buffer);for(let n=0;n<t;n++)r[e+n]=256*Math.random()|0},sock_recv(e,t,r){throw"sockets not supported"},sock_send(e,t,r){throw"sockets not supported"},sock_shutdown(e,t){throw"sockets not supported"}}}},File:a,PreopenDirectory:class extends _{constructor(e,t){super(new d(t)),this.prestat_name=new TextEncoder("utf-8").encode(e)}fd_prestat_get(){return{ret:0,prestat:l.dir(this.prestat_name.length)}}fd_prestat_dir_name(){return{ret:0,prestat_dir_name:this.prestat_name}}},strace:function(e,t){return new Proxy(e,{get(e,r,n){let s=Reflect.get(...arguments);return t.includes(r)?s:function(...e){return console.log(r,"(",...e,")"),Reflect.apply(s,n,e)}}})}};const b=document.getElementById("canvas");console.log(b);const x=20,U=20,k=b.getContext("2d"),D=20;b.width=x*D,b.height=U*D;const A=new(0,e.WASI)([],[],[]);function B(){console.log("echo:",p(w("hello world",(e=>V.echo(e))))),console.log("size before",g()),m("a","42"),m("b","21"),console.log("size after",g()),console.log("a=",y("a")),console.log("b=",y("b")),console.log("c=",y("c"))}const v={wasi_snapshot_preview1:A.wasiImport},T=await WebAssembly.instantiateStreaming(fetch("HaskellWASMSnake.wasm"),v);A.inst=T.instance;const V=T.instance.exports;async function I(){window.direction||(window.direction="s"),m("input",window.direction),V.updateGameStateIO();!function(e){k.clearRect(0,0,b.width,b.height);const t=e.trim().split("\n");console.log(t);for(let e=0;e<U;e++)for(let r=0;r<x;r++){const n=t[e][r];"*"===n?(k.fillStyle="black",k.fillRect(r*D,e*D,D,D)):"@"===n&&(k.fillStyle="red",k.fillRect(r*D,e*D,D,D))}}(y("output")),await new Promise((e=>setTimeout(e,150))),console.log("update"),console.log(window),window.isRunning&&window.requestAnimationFrame(I)}V._initialize(),V.hs_init(0,0),async function(){window.isRunning=!0,B(),I()}(),document.addEventListener("keydown",(e=>{window.direction=e.key,console.log(e.key)})),window.stop=()=>{window.isRunning=!1};
//# sourceMappingURL=index.19b8bdb1.js.map
